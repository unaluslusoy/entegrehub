{% extends 'layout/_user.html.twig' %}

{% block title %}{{ store.shopName ?? store.shopDomain }} - Detay{% endblock %}

{% block page_title %}{{ store.shopName ?? store.shopDomain }}{% endblock %}

{% block content %}
    <div class="container-xxl">
        <!--begin::Toolbar-->
        <div class="d-flex flex-wrap flex-stack pb-7">
            <div class="d-flex flex-wrap align-items-center">
                <a href="{{ path('user_shopify_index') }}" class="btn btn-sm btn-light-secondary me-3">
                    <i class="ki-duotone ki-arrow-left fs-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Geri
                </a>
                <h1 class="fw-bold me-3 my-1">{{ store.shopName ?? store.shopDomain }}</h1>
                {% if store.isActive %}
                    <span class="badge badge-success my-1">Aktif</span>
                {% else %}
                    <span class="badge badge-secondary my-1">Pasif</span>
                {% endif %}
            </div>
            <div class="d-flex flex-wrap my-1 gap-2">
                <button type="button" class="btn btn-sm btn-success" id="syncOrdersBtn">
                    <i class="ki-duotone ki-arrows-circle fs-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Siparişleri Senkronize Et
                </button>
                <button type="button" class="btn btn-sm btn-info" id="testConnectionBtn">
                    <i class="ki-duotone ki-shield-tick fs-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Bağlantıyı Test Et
                </button>
                <a href="{{ path('user_shopify_settings', {id: store.id}) }}" class="btn btn-sm btn-light-primary">
                    <i class="ki-duotone ki-setting-2 fs-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Ayarlar
                </a>
                <form method="post" action="{{ path('user_shopify_disconnect', {id: store.id}) }}" 
                      onsubmit="return confirm('Mağaza bağlantısını kesmek istediğinize emin misiniz?')">
                    <button type="submit" class="btn btn-sm btn-danger">
                        <i class="ki-duotone ki-disconnect fs-5">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                            <span class="path4"></span>
                            <span class="path5"></span>
                        </i>
                        Bağlantıyı Kes
                    </button>
                </form>
            </div>
        </div>
        <!--end::Toolbar-->

        <!--begin::Store Info-->
        <div class="row g-6 g-xl-9 mb-10">
            <div class="col-md-3">
                <div class="card h-md-100">
                    <div class="card-body">
                        <div class="fs-4 fw-bold text-gray-500 mb-2">Toplam Sipariş</div>
                        <div class="fs-1 fw-bolder text-primary">{{ store.totalOrdersSynced }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-md-100">
                    <div class="card-body">
                        <div class="fs-4 fw-bold text-gray-500 mb-2">Aktif Webhook</div>
                        <div class="fs-1 fw-bolder text-success">{{ webhooks|length }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-md-100">
                    <div class="card-body">
                        <div class="fs-4 fw-bold text-gray-500 mb-2">Senkronizasyon</div>
                        <div class="fs-1 fw-bolder text-info">{{ store.syncProgress }}%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-md-100">
                    <div class="card-body">
                        <div class="fs-4 fw-bold text-gray-500 mb-2">Son Senkronizasyon</div>
                        <div class="fs-6 fw-bold text-gray-700">
                            {% if store.lastOrderSyncAt %}
                                {{ store.lastOrderSyncAt|date('d.m.Y H:i') }}
                            {% else %}
                                Henüz yapılmadı
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--end::Store Info-->

        <div class="row g-6 g-xl-9">
            <!--begin::Webhooks-->
            <div class="col-xl-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Webhooks</h3>
                    </div>
                    <div class="card-body py-5">
                        {% if webhooks|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-row-bordered table-row-gray-100 gy-5">
                                    <thead>
                                        <tr class="fw-bold text-muted">
                                            <th>Topic</th>
                                            <th>Durum</th>
                                            <th>Oluşturulma</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for webhook in webhooks %}
                                        <tr>
                                            <td class="fw-bold">{{ webhook.topic }}</td>
                                            <td>
                                                {% if webhook.isActive %}
                                                    <span class="badge badge-light-success">Aktif</span>
                                                {% else %}
                                                    <span class="badge badge-light-secondary">Pasif</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ webhook.createdAt|date('d.m.Y H:i') }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-10">
                                <i class="ki-duotone ki-information-5 fs-3x mb-5">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                <div class="fw-bold">Henüz webhook kaydedilmedi</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!--end::Webhooks-->

            <!--begin::Sync Logs-->
            <div class="col-xl-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Senkronizasyon Geçmişi</h3>
                    </div>
                    <div class="card-body py-5">
                        {% if syncLogs|length > 0 %}
                            <div class="timeline-label">
                                {% for log in syncLogs %}
                                <div class="timeline-item">
                                    <div class="timeline-label fw-bold text-gray-800 fs-7">
                                        {{ log.createdAt|date('H:i') }}
                                    </div>
                                    <div class="timeline-badge">
                                        <i class="fa fa-genderless text-{{ log.status == 'completed' ? 'success' : (log.status == 'failed' ? 'danger' : 'warning') }} fs-1"></i>
                                    </div>
                                    <div class="fw-semibold text-gray-700 ps-3 fs-7">
                                        {{ log.syncType|capitalize }} - 
                                        {{ log.recordsSynced }}/{{ log.recordsTotal }} kayıt
                                        <span class="badge badge-light-{{ log.status == 'completed' ? 'success' : (log.status == 'failed' ? 'danger' : 'warning') }} ms-2">
                                            {{ log.status }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-10">
                                <i class="ki-duotone ki-time fs-3x mb-5">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <div class="fw-bold">Henüz senkronizasyon yapılmadı</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!--end::Sync Logs-->
        </div>

        <!--begin::Recent Orders-->
        <div class="row g-6 g-xl-9 mt-6">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Son Senkronize Edilen Siparişler</h3>
                    </div>
                    <div class="card-body py-5">
                        {% if orderMappings|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-row-bordered table-row-gray-100 gy-5">
                                    <thead>
                                        <tr class="fw-bold text-muted">
                                            <th>Shopify Sipariş No</th>
                                            <th>İç Sipariş ID</th>
                                            <th>Durum</th>
                                            <th>Son Senkronizasyon</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for mapping in orderMappings %}
                                        <tr>
                                            <td class="fw-bold">{{ mapping.shopifyOrderNumber }}</td>
                                            <td>
                                                {% if mapping.internalOrderId %}
                                                    <a href="#" class="text-gray-800 text-hover-primary">#{{ mapping.internalOrderId }}</a>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge badge-light-{{ mapping.syncStatus == 'synced' ? 'success' : (mapping.syncStatus == 'failed' ? 'danger' : 'warning') }}">
                                                    {{ mapping.syncStatus }}
                                                </span>
                                            </td>
                                            <td>{{ mapping.lastSyncAt|date('d.m.Y H:i') }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-10">
                                <i class="ki-duotone ki-basket fs-3x mb-5">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                </i>
                                <div class="fw-bold">Henüz sipariş senkronize edilmedi</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!--end::Recent Orders-->
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Sync orders
        document.getElementById('syncOrdersBtn').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Senkronize Ediliyor...';
            
            fetch('{{ path('user_shopify_sync_orders', {id: store.id}) }}', {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('Senkronizasyon başlatıldı!');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    toastr.error(data.error || 'Senkronizasyon başlatılamadı');
                    button.disabled = false;
                    button.innerHTML = '<i class="ki-duotone ki-arrows-circle fs-5"><span class="path1"></span><span class="path2"></span></i> Siparişleri Senkronize Et';
                }
            })
            .catch(error => {
                toastr.error('Bir hata oluştu');
                button.disabled = false;
                button.innerHTML = '<i class="ki-duotone ki-arrows-circle fs-5"><span class="path1"></span><span class="path2"></span></i> Siparişleri Senkronize Et';
            });
        });

        // Test connection
        document.getElementById('testConnectionBtn').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Test Ediliyor...';
            
            fetch('{{ path('user_shopify_test_connection', {id: store.id}) }}', {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('Bağlantı başarılı!');
                } else {
                    toastr.error('Bağlantı başarısız!');
                }
                button.disabled = false;
                button.innerHTML = '<i class="ki-duotone ki-shield-tick fs-5"><span class="path1"></span><span class="path2"></span></i> Bağlantıyı Test Et';
            })
            .catch(error => {
                toastr.error('Bir hata oluştu');
                button.disabled = false;
                button.innerHTML = '<i class="ki-duotone ki-shield-tick fs-5"><span class="path1"></span><span class="path2"></span></i> Bağlantıyı Test Et';
            });
        });
    </script>
{% endblock %}

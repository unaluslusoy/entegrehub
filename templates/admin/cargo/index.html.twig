{% extends 'layout/_admin.html.twig' %}

{% block title %}Kargo Firmaları{% endblock %}

{% block page_title %}Kargo Firma Yönetimi{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <span class="bullet bg-gray-500 w-5px h-2px"></span>
    </li>
    <li class="breadcrumb-item text-muted">Kargo Firmaları</li>
{% endblock %}

{% block toolbar %}
    <div class="d-flex align-items-center gap-2 gap-lg-3">
        <a href="{{ path('admin_cargo_companies_create') }}" class="btn btn-sm btn-primary">
            <i class="ki-duotone ki-plus fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            Yeni Kargo Firması
        </a>
    </div>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header border-0 pt-6">
            <div class="card-title">
                <div class="d-flex align-items-center gap-3">
                    <input type="text" 
                           id="cargo-search" 
                           class="form-control form-control-solid w-250px" 
                           placeholder="Kargo firması ara..." 
                           data-kt-search="true" />
                </div>
            </div>
        </div>

        <div class="card-body pt-0">
            {% if companies|length > 0 %}
                <div class="table-responsive">
                    <table class="table align-middle table-row-dashed fs-6 gy-5" id="kt_cargo_table">
                        <thead>
                            <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                                <th class="min-w-200px">KARGO FİRMASI</th>
                                <th class="min-w-100px">KOD</th>
                                <th class="min-w-100px">ÖNCELİK</th>
                                <th class="min-w-100px">MALİYET</th>
                                <th class="min-w-120px">GÖNDERİLER</th>
                                <th class="min-w-100px">API DURUM</th>
                                <th class="min-w-80px">DURUM</th>
                                <th class="text-end min-w-150px">İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody class="fw-semibold text-gray-600">
                            {% for company in companies %}
                            <tr data-cargo-id="{{ company.id }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if company.logo and company.logo starts with 'http' %}
                                        <img src="{{ company.logo }}" class="me-3 rounded" style="height: 30px;" alt="{{ company.name }}" />
                                        {% elseif company.logo %}
                                        <img src="{{ asset('uploads/cargo_companies/' ~ company.logo) }}" class="me-3 rounded" style="height: 30px;" alt="{{ company.name }}" />
                                        {% else %}
                                        <div class="symbol symbol-40px me-3">
                                            <div class="symbol-label bg-light-primary">
                                                <i class="ki-duotone ki-delivery fs-2 text-primary">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <a href="{{ path('admin_cargo_company_detail', {id: company.id}) }}" class="text-gray-800 text-hover-primary fw-bold">
                                                {{ company.name }}
                                            </a>
                                            {% if company.trackingUrl %}
                                            <div class="text-gray-500 fs-7">
                                                <i class="ki-duotone ki-geolocation fs-6">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                Takip mevcut
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-light-info">{{ company.code|upper }}</span>
                                </td>
                                <td>
                                    <span class="badge badge-light fs-7">{{ company.priority }}</span>
                                </td>
                                <td>
                                    {% if company.baseCost %}
                                    <div class="text-gray-800">{{ company.baseCost }} TRY</div>
                                    {% if company.costPerKg %}
                                    <div class="text-gray-500 fs-7">+ {{ company.costPerKg }} TRY/kg</div>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="text-gray-800 fw-bold">{{ stats[company.id].total_shipments }}</span>
                                        <span class="text-gray-500 fs-7">{{ stats[company.id].active_shipments }} aktif</span>
                                    </div>
                                </td>
                                <td>
                                    {% if company.apiUrl and company.credentials %}
                                        <span class="badge badge-light-success">Yapılandırılmış</span>
                                    {% elseif company.apiUrl %}
                                        <span class="badge badge-light-warning">Kısmi</span>
                                    {% else %}
                                        <span class="badge badge-light-secondary">Yok</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="form-check form-switch form-check-custom form-check-solid">
                                        <input class="form-check-input cargo-toggle" type="checkbox" 
                                               data-cargo-id="{{ company.id }}"
                                               {{ company.isActive ? 'checked' : '' }} />
                                    </div>
                                </td>
                                <td class="text-end">
                                    <button type="button" 
                                            class="btn btn-sm btn-light btn-active-light-primary"
                                            data-kt-menu-trigger="click" 
                                            data-kt-menu-placement="bottom-end">
                                        İşlemler
                                        <i class="ki-duotone ki-down fs-5 ms-1"></i>
                                    </button>
                                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-200px py-4" 
                                         data-kt-menu="true">
                                        <div class="menu-item px-3">
                                            <a href="{{ path('admin_cargo_company_detail', {id: company.id}) }}" 
                                               class="menu-link px-3">
                                                <i class="ki-duotone ki-eye fs-2 me-2">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                    <span class="path3"></span>
                                                </i>
                                                Detayları Görüntüle
                                            </a>
                                        </div>
                                        <div class="menu-item px-3">
                                            <a href="{{ path('admin_cargo_companies_edit', {id: company.id}) }}" 
                                               class="menu-link px-3">
                                                <i class="ki-duotone ki-pencil fs-2 me-2">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                Düzenle
                                            </a>
                                        </div>
                                        {% if company.apiUrl and company.credentials %}
                                        <div class="menu-item px-3">
                                            <a href="javascript:void(0)" 
                                               class="menu-link px-3 cargo-test"
                                               data-cargo-id="{{ company.id }}">
                                                <i class="ki-duotone ki-shield-tick fs-2 me-2">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                API Testi
                                            </a>
                                        </div>
                                        {% endif %}
                                        <div class="separator my-2"></div>
                                        <div class="menu-item px-3">
                                            <a href="javascript:void(0)" 
                                               class="menu-link px-3 cargo-toggle-link"
                                               data-cargo-id="{{ company.id }}"
                                               data-is-active="{{ company.isActive ? '1' : '0' }}">
                                                <i class="ki-duotone ki-toggle-{{ company.isActive ? 'off' : 'on' }} fs-2 me-2">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                {{ company.isActive ? 'Devre Dışı Bırak' : 'Aktif Et' }}
                                            </a>
                                        </div>
                                        {% if stats[company.id].total_shipments == 0 %}
                                        <div class="separator my-2"></div>
                                        <div class="menu-item px-3">
                                            <a href="javascript:void(0)" 
                                               class="menu-link px-3 text-danger cargo-delete"
                                               data-cargo-id="{{ company.id }}">
                                                <i class="ki-duotone ki-trash fs-2 me-2">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                    <span class="path3"></span>
                                                    <span class="path4"></span>
                                                    <span class="path5"></span>
                                                </i>
                                                Sil
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-10">
                    <i class="ki-duotone ki-information-5 fs-5x text-gray-400 mb-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <h3 class="text-gray-800 fw-bold mb-3">Henüz kargo firması eklenmemiş</h3>
                    <p class="text-gray-600 mb-5">Sistemde kullanmak için kargo firmaları ekleyin</p>
                    <a href="{{ path('admin_cargo_companies_create') }}" class="btn btn-primary">
                        <i class="ki-duotone ki-plus fs-2"></i>
                        İlk Kargo Firmasını Ekle
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Search
        document.getElementById('cargo-search')?.addEventListener('input', function(e) {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('tbody tr[data-cargo-id]').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        });

        // Toggle active status from dropdown menu
        document.querySelectorAll('.cargo-toggle-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const cargoId = this.dataset.cargoId;
                fetch(`/admin/cargo-companies/${cargoId}/toggle`, {
                    method: 'POST'
                })
                .then(r => r.json())
                .then(data => {
                    toastr.success(data.message);
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(() => {
                    toastr.error('Durum güncellenemedi');
                });
            });
        });

        // Toggle active status from switch
        document.querySelectorAll('.cargo-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const cargoId = this.dataset.cargoId;
                fetch(`/admin/cargo-companies/${cargoId}/toggle`, {
                    method: 'POST'
                })
                .then(r => r.json())
                .then(data => {
                    toastr.success(data.message);
                })
                .catch(() => {
                    this.checked = !this.checked;
                    toastr.error('Durum güncellenemedi');
                });
            });
        });

        // Test API connection
        document.querySelectorAll('.cargo-test').forEach(btn => {
            btn.addEventListener('click', function() {
                const cargoId = this.dataset.cargoId;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                this.disabled = true;

                fetch(`/admin/cargo-companies/${cargoId}/test-connection`, {
                    method: 'POST'
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(data.message);
                    } else {
                        toastr.error(data.message);
                    }
                })
                .catch(err => {
                    toastr.error('Bağlantı testi başarısız');
                })
                .finally(() => {
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                });
            });
        });

        // Delete cargo company
        document.querySelectorAll('.cargo-delete').forEach(btn => {
            btn.addEventListener('click', function() {
                const cargoId = this.dataset.cargoId;
                if (confirm('Kargo firmasını silmek istediğinizden emin misiniz?')) {
                    fetch(`/admin/cargo-companies/${cargoId}/delete`, {
                        method: 'POST'
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            toastr.success(data.message);
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            toastr.error(data.message);
                        }
                    });
                }
            });
        });
    </script>
{% endblock %}

{% extends 'layout/_admin.html.twig' %}

{% block title %}Kargo Firması Düzenle{% endblock %}

{% block page_title %}{{ company.name }} - Düzenle{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <span class="bullet bg-gray-500 w-5px h-2px"></span>
    </li>
    <li class="breadcrumb-item text-muted">
        <a href="{{ path('admin_cargo_companies') }}" class="text-muted text-hover-primary">Kargo Firmaları</a>
    </li>
    <li class="breadcrumb-item">
        <span class="bullet bg-gray-500 w-5px h-2px"></span>
    </li>
    <li class="breadcrumb-item text-muted">{{ company.name }}</li>
{% endblock %}

{% block content %}
    <form method="post">
        <div class="row g-5">
            <div class="col-xl-8">
                {# Basic Info #}
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="card-title">Temel Bilgiler</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-5">
                            <div class="col-md-6">
                                <label class="form-label required">Firma Adı</label>
                                <input type="text" name="name" class="form-control" value="{{ company.name }}" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">Firma Kodu</label>
                                <input type="text" name="code" class="form-control" value="{{ company.code }}" required />
                                <div class="form-text">Küçük harf ve tire kullanın</div>
                            </div>
                        </div>

                        <div class="row mb-5">
                            <div class="col-md-12">
                                <label class="form-label">Logo URL</label>
                                <input type="url" name="logo" class="form-control" value="{{ company.logo }}" />
                                {% if company.logo %}
                                <div class="mt-3">
                                    <img src="{{ company.logo }}" style="height: 40px;" alt="{{ company.name }}" />
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-5">
                            <div class="col-md-4">
                                <label class="form-label">Öncelik</label>
                                <input type="number" name="priority" class="form-control" value="{{ company.priority }}" min="0" step="1" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Temel Maliyet (TRY)</label>
                                <input type="number" name="base_cost" class="form-control" value="{{ company.baseCost }}" min="0" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Kg Başı Maliyet (TRY)</label>
                                <input type="number" name="cost_per_kg" class="form-control" value="{{ company.costPerKg }}" min="0" step="0.01" />
                            </div>
                        </div>
                    </div>
                </div>

                {# API Configuration #}
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="card-title">API Yapılandırması</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-5">
                            <label class="form-label">API URL</label>
                            <input type="url" name="api_url" class="form-control" value="{{ company.apiUrl }}" />
                        </div>

                        <div class="mb-5">
                            <label class="form-label">Takip URL Şablonu</label>
                            <input type="text" name="tracking_url" class="form-control" value="{{ company.trackingUrl }}" />
                            <div class="form-text">{tracking_number} yerine gerçek takip numarası konulacak</div>
                        </div>

                        <div class="separator separator-dashed my-8"></div>

                        <h5 class="mb-5">API Kimlik Bilgileri</h5>

                        <div class="row mb-5">
                            <div class="col-md-6">
                                <label class="form-label">API Key</label>
                                <input type="text" name="api_key" class="form-control" 
                                       value="{{ company.credentials.api_key ?? '' }}" 
                                       placeholder="Değiştirmek için yeni değer girin" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">API Secret</label>
                                <input type="password" name="api_secret" class="form-control" 
                                       placeholder="Değiştirmek için yeni değer girin" />
                                {% if company.credentials.api_secret ?? false %}
                                <div class="form-text text-success">
                                    <i class="ki-duotone ki-check-circle fs-6"></i>
                                    Ayarlanmış
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-5">
                            <div class="col-md-6">
                                <label class="form-label">Kullanıcı Adı</label>
                                <input type="text" name="username" class="form-control" 
                                       value="{{ company.credentials.username ?? '' }}" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Şifre</label>
                                <input type="password" name="password" class="form-control" 
                                       placeholder="Değiştirmek için yeni değer girin" />
                                {% if company.credentials.password ?? false %}
                                <div class="form-text text-success">
                                    <i class="ki-duotone ki-check-circle fs-6"></i>
                                    Ayarlanmış
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# Settings #}
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="card-title">Gelişmiş Ayarlar</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-5">
                            <label class="form-label">Desteklenen Servis Tipleri</label>
                            <input type="text" name="service_types" class="form-control" 
                                   value="{{ company.settings.service_types|default([])|join(',') }}" />
                            <div class="form-text">Virgülle ayırarak yazın</div>
                        </div>

                        <div class="row mb-5">
                            <div class="col-md-6">
                                <label class="form-label">Maksimum Ağırlık (kg)</label>
                                <input type="number" name="max_weight" class="form-control" 
                                       value="{{ company.settings.max_weight ?? '' }}" min="0" step="0.1" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">API Timeout (saniye)</label>
                                <input type="number" name="timeout" class="form-control" 
                                       value="{{ company.settings.timeout ?? 30 }}" min="5" step="1" />
                            </div>
                        </div>

                        <div class="mb-5">
                            <div class="form-check form-switch form-check-custom form-check-solid">
                                <input class="form-check-input" type="checkbox" name="test_mode" value="1" 
                                       id="test-mode" {{ company.settings.test_mode ?? false ? 'checked' : '' }} />
                                <label class="form-check-label" for="test-mode">
                                    Test Modu
                                </label>
                            </div>
                            <div class="form-text">API çağrıları test sunucusuna yapılır</div>
                        </div>

                        <div class="mb-5">
                            <label class="form-label">Notlar</label>
                            <textarea name="notes" class="form-control" rows="3">{{ company.notes }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4">
                {# Quick Actions #}
                <div class="card card-flush mb-5">
                    <div class="card-header">
                        <h3 class="card-title">Hızlı İşlemler</h3>
                    </div>
                    <div class="card-body">
                        {% if company.apiUrl and company.credentials %}
                        <button type="button" class="btn btn-light-primary w-100 mb-3" id="test-connection">
                            <i class="ki-duotone ki-shield-tick fs-2"></i>
                            API Bağlantısını Test Et
                        </button>
                        {% endif %}

                        <a href="{{ path('admin_cargo_company_detail', {id: company.id}) }}" class="btn btn-light w-100 mb-3">
                            <i class="ki-duotone ki-eye fs-2"></i>
                            Detay Sayfasına Git
                        </a>

                        <div class="separator my-5"></div>

                        <div class="mb-5">
                            <h5 class="mb-3">Durum</h5>
                            <div class="form-check form-switch form-check-custom form-check-solid">
                                <input class="form-check-input" type="checkbox" name="is_active" value="1" 
                                       id="is-active" {{ company.isActive ? 'checked' : '' }} />
                                <label class="form-check-label" for="is-active">
                                    Aktif
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                {# Company Info #}
                <div class="card card-flush mb-5">
                    <div class="card-body">
                        <div class="mb-5">
                            <label class="text-gray-600 fs-7">Oluşturulma</label>
                            <div class="fw-bold">{{ company.createdAt|date('d.m.Y H:i') }}</div>
                        </div>
                        <div>
                            <label class="text-gray-600 fs-7">Son Güncelleme</label>
                            <div class="fw-bold">{{ company.updatedAt|date('d.m.Y H:i') }}</div>
                        </div>
                    </div>
                </div>

                {# Save Button #}
                <div class="card card-flush">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="ki-duotone ki-check fs-2"></i>
                            Değişiklikleri Kaydet
                        </button>
                        <a href="{{ path('admin_cargo_company_detail', {id: company.id}) }}" class="btn btn-light w-100">
                            İptal
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.getElementById('test-connection')?.addEventListener('click', function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Test ediliyor...';
            btn.disabled = true;

            fetch('{{ path('admin_cargo_companies_test', {id: company.id}) }}', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    toastr.success(data.message);
                } else {
                    toastr.error(data.message);
                }
            })
            .catch(err => {
                toastr.error('Bağlantı testi başarısız');
            })
            .finally(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
        });
    </script>
{% endblock %}

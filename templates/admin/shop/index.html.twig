{% extends 'layout/_admin.html.twig' %}

{% block title %}Mağazalarım{% endblock %}

{% block page_title %}Mağazalarım{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <span class="bullet bg-gray-500 w-5px h-2px"></span>
    </li>
    <li class="breadcrumb-item text-muted">Mağazalarım</li>
{% endblock %}

{% block toolbar %}
    <div class="d-flex align-items-center gap-2 gap-lg-3">
        {% if is_granted('ROLE_SUPER_ADMIN') %}
        <a href="{{ path('admin_shops') }}" class="btn btn-sm btn-light-primary">
            <i class="ki-duotone ki-arrows-circle fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            Yenile
        </a>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header border-0 pt-6">
            <div class="card-title">
                <div class="d-flex align-items-center position-relative my-1">
                    <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <input type="text" id="shop-search" class="form-control form-control-solid w-250px ps-13" placeholder="Mağaza ara..." />
                </div>
            </div>
        </div>

        <div class="card-body pt-0">
            {% if shops|length > 0 %}
                <div class="table-responsive">
                    <table class="table align-middle table-row-dashed fs-6 gy-5">
                        <thead>
                            <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                                <th class="min-w-200px">MAĞAZA</th>
                                <th class="min-w-100px">DURUM</th>
                                <th class="min-w-100px">OTO SENKRON</th>
                                <th class="min-w-125px">SON SENKRON</th>
                                <th class="min-w-125px">KURULUM TARİHİ</th>
                                <th class="text-end min-w-100px">İŞLEMLER</th>
                            </tr>
                        </thead>
                        <tbody class="fw-semibold text-gray-600">
                            {% for shop in shops %}
                            <tr data-shop-id="{{ shop.id }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="symbol symbol-50px me-5">
                                            <span class="symbol-label bg-light-primary">
                                                <i class="ki-duotone ki-shop fs-2x text-primary">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </span>
                                        </div>
                                        <div class="d-flex flex-column">
                                            <a href="#" class="text-gray-800 text-hover-primary mb-1 fw-bold">
                                                {{ shop.shopName }}
                                            </a>
                                            <span class="text-gray-500">{{ shop.shopDomain }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check form-switch form-check-custom form-check-solid">
                                        <input class="form-check-input shop-active-toggle" type="checkbox" 
                                               data-shop-id="{{ shop.id }}" 
                                               {{ shop.isActive ? 'checked' : '' }} />
                                        <label class="form-check-label">
                                            <span class="badge {{ shop.isActive ? 'badge-light-success' : 'badge-light-danger' }}">
                                                {{ shop.isActive ? 'Aktif' : 'Pasif' }}
                                            </span>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check form-switch form-check-custom form-check-solid">
                                        <input class="form-check-input shop-autosync-toggle" type="checkbox" 
                                               data-shop-id="{{ shop.id }}" 
                                               {{ shop.isAutoSync ? 'checked' : '' }} />
                                    </div>
                                </td>
                                <td>
                                    {% if shop.lastSyncAt %}
                                        <span class="text-gray-800">{{ shop.lastSyncAt|date('d.m.Y H:i') }}</span>
                                    {% else %}
                                        <span class="text-gray-500">Henüz senkronize edilmedi</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-gray-800">{{ shop.installedAt|date('d.m.Y') }}</span>
                                </td>
                                <td class="text-end">
                                    <a href="#" class="btn btn-light btn-active-light-primary btn-sm" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                                        İşlemler
                                        <i class="ki-duotone ki-down fs-5 ms-1"></i>
                                    </a>
                                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-200px py-4" data-kt-menu="true">
                                        <div class="menu-item px-3">
                                            <a href="#" class="menu-link px-3">
                                                <i class="ki-duotone ki-eye fs-5 me-2"></i>
                                                Detaylar
                                            </a>
                                        </div>
                                        <div class="menu-item px-3">
                                            <a href="#" class="menu-link px-3 shop-sync-btn" data-shop-id="{{ shop.id }}">
                                                <i class="ki-duotone ki-arrows-circle fs-5 me-2"></i>
                                                Senkronize Et
                                            </a>
                                        </div>
                                        <div class="menu-item px-3">
                                            <a href="#" class="menu-link px-3 shop-verify-btn" data-shop-id="{{ shop.id }}">
                                                <i class="ki-duotone ki-check-circle fs-5 me-2"></i>
                                                Bağlantıyı Doğrula
                                            </a>
                                        </div>
                                        <div class="separator my-2"></div>
                                        <div class="menu-item px-3">
                                            <a href="{{ path('shopify_reconnect', {id: shop.id}) }}" class="menu-link px-3 text-warning">
                                                <i class="ki-duotone ki-reload fs-5 me-2"></i>
                                                Yeniden Bağla
                                            </a>
                                        </div>
                                        <div class="menu-item px-3">
                                            <a href="#" class="menu-link px-3 text-danger shop-delete-btn" data-shop-id="{{ shop.id }}">
                                                <i class="ki-duotone ki-trash fs-5 me-2"></i>
                                                Kaldır
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-20">
                    <i class="ki-duotone ki-shop fs-5x text-gray-400 mb-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <h3 class="text-gray-800 fw-bold mb-3">Henüz mağaza bulunmuyor</h3>
                    <p class="text-gray-600 mb-5">Kullanıcılar tarafından bağlanmış mağaza bulunmamaktadır.</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('shop-search');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Active toggle
        document.querySelectorAll('.shop-active-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const shopId = this.dataset.shopId;
                const isActive = this.checked;
                
                fetch(`/admin/shops/${shopId}/toggle-active`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(data.message);
                        location.reload();
                    } else {
                        toastr.error(data.error);
                        this.checked = !isActive;
                    }
                })
                .catch(error => {
                    toastr.error('İşlem başarısız oldu');
                    this.checked = !isActive;
                });
            });
        });

        // Auto sync toggle
        document.querySelectorAll('.shop-autosync-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const shopId = this.dataset.shopId;
                const autoSync = this.checked;
                
                fetch(`/admin/shops/${shopId}/toggle-auto-sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(data.message);
                    } else {
                        toastr.error(data.error);
                        this.checked = !autoSync;
                    }
                })
                .catch(error => {
                    toastr.error('İşlem başarısız oldu');
                    this.checked = !autoSync;
                });
            });
        });

        // Sync button
        document.querySelectorAll('.shop-sync-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const shopId = this.dataset.shopId;
                
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Senkronize ediliyor...';
                btn.disabled = true;
                
                fetch(`/admin/shops/${shopId}/sync`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        toastr.error(data.error);
                        btn.innerHTML = 'Senkronize Et';
                        btn.disabled = false;
                    }
                })
                .catch(error => {
                    toastr.error('Senkronizasyon başarısız oldu');
                    btn.innerHTML = 'Senkronize Et';
                    btn.disabled = false;
                });
            });
        });

        // Verify button
        document.querySelectorAll('.shop-verify-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const shopId = this.dataset.shopId;
                
                fetch(`/admin/shops/${shopId}/verify`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.is_valid) {
                        toastr.success(data.message);
                    } else {
                        toastr.error(data.error);
                    }
                })
                .catch(error => {
                    toastr.error('Doğrulama başarısız oldu');
                });
            });
        });

        // Delete button
        document.querySelectorAll('.shop-delete-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const shopId = this.dataset.shopId;
                
                if (confirm('Bu mağazayı kaldırmak istediğinize emin misiniz?')) {
                    fetch(`/admin/shops/${shopId}/delete`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            toastr.success(data.message);
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            toastr.error(data.error);
                        }
                    })
                    .catch(error => {
                        toastr.error('Silme işlemi başarısız oldu');
                    });
                }
            });
        });
    });
    </script>
{% endblock %}

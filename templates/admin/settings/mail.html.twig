{% extends 'layout/_admin.html.twig' %}

{% block title %}Mail Ayarları{% endblock %}

{% block page_title %}Mail Ayarları{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <span class="bullet bg-gray-500 w-5px h-2px"></span>
    </li>
    <li class="breadcrumb-item text-muted">Ayarlar</li>
    <li class="breadcrumb-item">
        <span class="bullet bg-gray-500 w-5px h-2px"></span>
    </li>
    <li class="breadcrumb-item text-muted">Mail</li>
{% endblock %}

{% block content %}
    <form method="post">
        <div class="row g-5">
            <div class="col-xl-9">
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="card-title">SMTP Ayarları</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-5">
                            <label class="form-label">Mail Sürücüsü</label>
                            <select name="mail_driver" class="form-select">
                                <option value="smtp" {{ settings.mail_driver|default('smtp') == 'smtp' ? 'selected' : '' }}>SMTP</option>
                                <option value="sendmail" {{ settings.mail_driver == 'sendmail' ? 'selected' : '' }}>Sendmail</option>
                            </select>
                        </div>

                        <div class="row mb-5">
                            <div class="col-md-8">
                                <label class="form-label">SMTP Host</label>
                                <input type="text" name="mail_host" class="form-control" 
                                       value="{{ settings.mail_host ?? '' }}" placeholder="smtp.gmail.com" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Port</label>
                                <input type="number" name="mail_port" class="form-control" 
                                       value="{{ settings.mail_port ?? 587 }}" />
                            </div>
                        </div>

                        <div class="row mb-5">
                            <div class="col-md-6">
                                <label class="form-label">Kullanıcı Adı</label>
                                <input type="text" name="mail_username" class="form-control" 
                                       value="{{ settings.mail_username ?? '' }}" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Şifre</label>
                                <input type="password" name="mail_password" class="form-control" 
                                       placeholder="Değiştirmek için yeni şifre girin" />
                                {% if settings.mail_password %}
                                <div class="form-text text-success">
                                    <i class="ki-duotone ki-check-circle fs-6"></i>
                                    Şifre ayarlanmış
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-5">
                            <label class="form-label">Şifreleme</label>
                            <select name="mail_encryption" class="form-select">
                                <option value="">Yok</option>
                                <option value="tls" {{ settings.mail_encryption|default('tls') == 'tls' ? 'selected' : '' }}>TLS</option>
                                <option value="ssl" {{ settings.mail_encryption == 'ssl' ? 'selected' : '' }}>SSL</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Gönderen Bilgileri</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-5">
                                <label class="form-label">Gönderen Email</label>
                                <input type="email" name="mail_from_address" class="form-control" 
                                       value="{{ settings.mail_from_address ?? '' }}" placeholder="noreply@example.com" />
                            </div>
                            <div class="col-md-6 mb-5">
                                <label class="form-label">Gönderen Adı</label>
                                <input type="text" name="mail_from_name" class="form-control" 
                                       value="{{ settings.mail_from_name ?? 'Kargo Sistem' }}" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3">
                <div class="card card-flush mb-5">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="ki-duotone ki-check fs-2"></i>
                            Ayarları Kaydet
                        </button>

                        <button type="button" class="btn btn-light-primary w-100" id="test-mail">
                            <i class="ki-duotone ki-send fs-2"></i>
                            Test Mail Gönder
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    {# Test Mail Modal #}
    <div class="modal fade" id="test-mail-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test Mail Gönder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Email Adresi</label>
                    <input type="email" id="test-email" class="form-control" placeholder="test@example.com" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="send-test-mail">Gönder</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.getElementById('test-mail')?.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('test-mail-modal'));
            modal.show();
        });

        document.getElementById('send-test-mail')?.addEventListener('click', function() {
            const email = document.getElementById('test-email').value;
            const btn = this;
            const originalHtml = btn.innerHTML;
            
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gönderiliyor...';
            btn.disabled = true;

            fetch('{{ path('admin_settings_mail_test') }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: email })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    toastr.success(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('test-mail-modal')).hide();
                } else {
                    toastr.error(data.message);
                }
            })
            .finally(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
        });
    </script>
{% endblock %}

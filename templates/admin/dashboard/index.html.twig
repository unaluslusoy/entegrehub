{% extends 'layout/_admin.html.twig' %}

{% block title %}Kargo Yönetim Paneli{% endblock %}

{% block page_title %}Kargo Yönetim Paneli{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <span class="bullet bg-gray-500 w-5px h-2px"></span>
    </li>
    <li class="breadcrumb-item text-muted">Dashboard</li>
{% endblock %}

{% block toolbar %}
    <div class="d-flex align-items-center gap-2 gap-lg-3">
        <a href="#" class="btn btn-sm btn-light-primary">
            <i class="ki-duotone ki-book-open fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
            </i>
            Hızlı Rehber
        </a>
        <a href="#" class="btn btn-sm btn-success">
            <i class="ki-duotone ki-delivery fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
            Yeni Gönderi
        </a>
    </div>
{% endblock %}

{% block content %}
    {# Quick Stats Row - Metronic Style #}
    <div class="row g-5 g-xl-10 mb-5 mb-xl-10">
        {# Projects Card #}
        <div class="col-md-6 col-lg-6 col-xl-6 col-xxl-3 mb-md-5 mb-xl-10">
            <div class="card card-flush bgi-no-repeat bgi-size-contain bgi-position-x-end h-md-50 mb-5 mb-xl-10" style="background-color: #F1416C;background-image:url('{{ asset('build/media/patterns/vector-1.png') }}')">
                <div class="card-header pt-5">
                    <div class="card-title d-flex flex-column">
                        <span class="fs-2hx fw-bold text-white me-2 lh-1 ls-n2">{{ stats.active_shipments }}</span>
                        <span class="text-white opacity-75 pt-1 fw-semibold fs-6">Aktif Gönderiler</span>
                    </div>
                </div>
                <div class="card-body d-flex align-items-end pt-0">
                    <div class="d-flex align-items-center flex-column mt-3 w-100">
                        <div class="d-flex justify-content-between fw-bold fs-6 text-white opacity-75 w-100 mt-auto mb-2">
                            <span>{{ stats.pending_orders }} Bekleyen</span>
                            <span>{{ stats.total_orders > 0 ? ((stats.pending_orders / stats.total_orders) * 100)|number_format(0) : 0 }}%</span>
                        </div>
                        <div class="h-8px mx-3 w-100 bg-white bg-opacity-50 rounded">
                            <div class="bg-white rounded h-8px" role="progressbar" style="width: {{ stats.total_orders > 0 ? ((stats.pending_orders / stats.total_orders) * 100) : 0 }}%" aria-valuenow="{{ stats.pending_orders }}" aria-valuemin="0" aria-valuemax="{{ stats.total_orders }}"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card card-flush h-md-50 mb-xl-10">
                <div class="card-header pt-5">
                    <div class="card-title d-flex flex-column">
                        <div class="d-flex align-items-center">
                            <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">{{ stats.total_shops }}</span>
                            <span class="badge badge-light-success fs-base">
                                <i class="ki-duotone ki-arrow-up fs-5 text-success ms-n1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                {{ stats.shop_growth|default(2.2) }}%
                            </span>
                        </div>
                        <span class="text-gray-500 pt-1 fw-semibold fs-6">Toplam Mağaza</span>
                    </div>
                </div>
                <div class="card-body d-flex align-items-end pt-0">
                    <div class="d-flex align-items-center flex-column mt-3 w-100">
                        <div class="d-flex justify-content-between text-gray-500 fw-bold fs-6 w-100 mt-auto mb-2">
                            <span>Aktif Mağazalar</span>
                            <span>{{ stats.active_shops }} / {{ stats.total_shops }}</span>
                        </div>
                        <div class="h-8px mx-3 w-100 bg-light-success rounded">
                            <div class="bg-success rounded h-8px" role="progressbar" style="width: {{ stats.total_shops > 0 ? ((stats.active_shops / stats.total_shops) * 100) : 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Revenue Card #}
        <div class="col-md-6 col-lg-6 col-xl-6 col-xxl-3 mb-md-5 mb-xl-10">
            <div class="card card-flush h-md-50 mb-5 mb-xl-10">
                <div class="card-header pt-5">
                    <div class="card-title d-flex flex-column">
                        <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">{{ stats.revenue_this_month|number_format(0, ',', '.') }}₺</span>
                        <span class="text-gray-500 pt-1 fw-semibold fs-6">Bu Ay Ciro</span>
                    </div>
                </div>
                <div class="card-body d-flex flex-column justify-content-end pe-0">
                    <span class="fs-6 fw-bolder text-gray-800 d-block mb-2">Bugünkü Gönderiler</span>
                    <div class="symbol-group symbol-hover flex-nowrap">
                        <div class="symbol symbol-35px symbol-circle" data-bs-toggle="tooltip" title="Aras Kargo">
                            <span class="symbol-label bg-warning text-inverse-warning fw-bold">A</span>
                        </div>
                        <div class="symbol symbol-35px symbol-circle" data-bs-toggle="tooltip" title="MNG Kargo">
                            <span class="symbol-label bg-info text-inverse-info fw-bold">M</span>
                        </div>
                        <div class="symbol symbol-35px symbol-circle" data-bs-toggle="tooltip" title="Yurtiçi Kargo">
                            <span class="symbol-label bg-success text-inverse-success fw-bold">Y</span>
                        </div>
                        <div class="symbol symbol-35px symbol-circle" data-bs-toggle="tooltip" title="Sürat Kargo">
                            <span class="symbol-label bg-danger text-inverse-danger fw-bold">S</span>
                        </div>
                        <div class="symbol symbol-35px symbol-circle" data-bs-toggle="tooltip" title="+3 daha">
                            <span class="symbol-label bg-dark text-inverse-dark fw-bold">+3</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card card-flush h-md-50 mb-xl-10">
                <div class="card-header pt-5">
                    <div class="card-title d-flex flex-column">
                        <div class="d-flex align-items-center">
                            <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">{{ stats.orders_this_month }}</span>
                            {% if stats.order_growth > 0 %}
                                <span class="badge badge-light-success fs-base">
                                    <i class="ki-duotone ki-arrow-up fs-5 text-success ms-n1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    {{ stats.order_growth }}%
                                </span>
                            {% elseif stats.order_growth < 0 %}
                                <span class="badge badge-light-danger fs-base">
                                    <i class="ki-duotone ki-arrow-down fs-5 text-danger ms-n1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    {{ stats.order_growth|abs }}%
                                </span>
                            {% endif %}
                        </div>
                        <span class="text-gray-500 pt-1 fw-semibold fs-6">Toplam Siparişler</span>
                    </div>
                </div>
                <div class="card-body d-flex align-items-end pt-0">
                    <div class="d-flex align-items-center flex-column mt-3 w-100">
                        <div class="d-flex justify-content-between fw-bold fs-6 text-gray-500 w-100 mt-auto mb-2">
                            <span>Tamamlanan</span>
                            <span>{{ stats.completed_orders|default(0) }}</span>
                        </div>
                        <div class="h-8px mx-3 w-100 bg-light-primary rounded">
                            <div class="bg-primary rounded h-8px" role="progressbar" style="width: {{ stats.orders_this_month > 0 ? ((stats.completed_orders|default(0) / stats.orders_this_month) * 100) : 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Performance Chart #}
        <div class="col-xxl-6">
            <div class="card card-flush overflow-hidden h-md-100">
                <div class="card-header py-5">
                    <h3 class="card-title align-items-start flex-column">
                        <span class="card-label fw-bold text-gray-900">Performans Görünümü</span>
                        <span class="text-gray-500 mt-1 fw-semibold fs-6">Tüm kanallardan kullanıcılar</span>
                    </h3>
                    <div class="card-toolbar">
                        <button type="button" class="btn btn-sm btn-icon btn-color-primary btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                            <i class="ki-duotone ki-category fs-6">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </button>
                        <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-800 menu-state-bg-light-primary fw-semibold w-200px" data-kt-menu="true">
                            <div class="menu-item px-3">
                                <div class="menu-content fs-6 text-gray-900 fw-bold px-3 py-4">Hızlı Eylemler</div>
                            </div>
                            <div class="separator mb-3 opacity-75"></div>
                            <div class="menu-item px-3">
                                <a href="#" class="menu-link px-3">Yeni Gönderi</a>
                            </div>
                            <div class="menu-item px-3">
                                <a href="#" class="menu-link px-3">Toplu İşlem</a>
                            </div>
                            <div class="menu-item px-3">
                                <a href="#" class="menu-link px-3">Rapor İndir</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body d-flex justify-content-between flex-column pb-1 px-0">
                    <div class="px-9 mb-5">
                        <div class="d-flex mb-2">
                            <span class="fs-4 fw-semibold text-gray-500 me-1">₺</span>
                            <span class="fs-2hx fw-bold text-gray-800 me-2 lh-1 ls-n2">{{ stats.avg_cost_per_shipment|default(8.55)|number_format(2) }}</span>
                            <span class="badge badge-light-success fs-base">
                                <i class="ki-duotone ki-arrow-up fs-5 text-success ms-n1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                2.2%
                            </span>
                        </div>
                        <span class="fs-6 fw-semibold text-gray-500">Ortalama Gönderi Maliyeti</span>
                    </div>
                    <div id="kt_card_widget_17_chart" class="min-h-auto ps-4 pe-6" style="height: 300px"></div>
                </div>
            </div>
        </div>
    </div>

    {# Shipment History & Active Shops #}
    <div class="row g-5 g-xl-10 mb-5 mb-xl-10">
        {# Recent Shipments #}
        <div class="col-xl-8">
            <div class="card card-flush h-xl-100">
                <div class="card-header pt-7">
                    <h3 class="card-title align-items-start flex-column">
                        <span class="card-label fw-bold text-gray-800">Gönderi Geçmişi</span>
                        <span class="text-gray-500 mt-1 fw-semibold fs-6">{{ stats.active_shipments }} aktif gönderi</span>
                    </h3>
                    <div class="card-toolbar">
                        <a href="#" class="btn btn-sm btn-light">Tümünü Gör</a>
                    </div>
                </div>
                <div class="card-body pt-6">
                    {% if recent_shipments|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-row-dashed align-middle gs-0 gy-4 my-0">
                                <thead>
                                    <tr class="fs-7 fw-bold text-gray-500 border-bottom-0">
                                        <th class="p-0 pb-3 min-w-50px">TİP</th>
                                        <th class="p-0 pb-3 min-w-150px">TAKİP NO</th>
                                        <th class="p-0 pb-3 min-w-150px">NEREDEN</th>
                                        <th class="p-0 pb-3 min-w-150px">NEREYE</th>
                                        <th class="p-0 pb-3 min-w-100px">DURUM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for shipment in recent_shipments %}
                                    <tr>
                                        <td>
                                            {% set carrier_icons = {
                                                'ups': 'delivery-3',
                                                'dhl': 'airplane-square',
                                                'fedex': 'delivery-2',
                                                'usps': 'geolocation',
                                                'yurtici': 'delivery'
                                            } %}
                                            <i class="ki-duotone ki-{{ carrier_icons[shipment.carrier|lower] ?? 'delivery' }} fs-2x text-primary">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                                <span class="path4"></span>
                                                <span class="path5"></span>
                                            </i>
                                        </td>
                                        <td>
                                            <a href="#" class="text-gray-800 text-hover-primary fw-bold">{{ shipment.trackingNumber }}</a>
                                        </td>
                                        <td>
                                            <span class="text-gray-800 fw-semibold d-block fs-7">{{ shipment.originCity ?? 'N/A' }}</span>
                                            <span class="text-gray-500 fw-semibold d-block fs-8">{{ shipment.originCountry ?? '' }}</span>
                                        </td>
                                        <td>
                                            <span class="text-gray-800 fw-semibold d-block fs-7">{{ shipment.destinationCity ?? 'N/A' }}</span>
                                            <span class="text-gray-500 fw-semibold d-block fs-8">{{ shipment.destinationCountry ?? '' }}</span>
                                        </td>
                                        <td>
                                            {% set status_badges = {
                                                'pending': 'badge-light-warning',
                                                'in_transit': 'badge-light-info',
                                                'delivered': 'badge-light-success',
                                                'cancelled': 'badge-light-danger'
                                            } %}
                                            {% set status_labels = {
                                                'pending': 'Bekliyor',
                                                'in_transit': 'Yolda',
                                                'delivered': 'Teslim Edildi',
                                                'cancelled': 'İptal'
                                            } %}
                                            <span class="badge {{ status_badges[shipment.status] ?? 'badge-light' }}">
                                                {{ status_labels[shipment.status] ?? shipment.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-10">
                            <i class="ki-duotone ki-delivery fs-5x text-gray-400 mb-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                            <h3 class="text-gray-800 fs-3 fw-bold mb-2">Henüz Gönderi Yok</h3>
                            <p class="text-gray-500 fs-6">İlk gönderinizi oluşturmak için yukarıdaki butonu kullanın</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Active Shops #}
        <div class="col-xl-4">
            <div class="card card-flush h-xl-100">
                <div class="card-header pt-7">
                    <h3 class="card-title align-items-start flex-column">
                        <span class="card-label fw-bold text-gray-800">Aktif Mağazalar</span>
                        <span class="text-gray-500 mt-1 fw-semibold fs-6">{{ stats.active_shops }} / {{ stats.total_shops }}</span>
                    </h3>
                    <div class="card-toolbar">
                        <a href="{{ path('admin_shops') }}" class="btn btn-sm btn-light">Tümünü Gör</a>
                    </div>
                </div>
                <div class="card-body pt-5">
                    {% if active_shops|length > 0 %}
                        {% for shop in active_shops %}
                        <div class="d-flex flex-stack mb-5">
                            <div class="d-flex align-items-center me-3">
                                <span class="symbol symbol-50px me-4">
                                    <i class="ki-duotone ki-shop fs-2x text-primary">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                        <span class="path4"></span>
                                        <span class="path5"></span>
                                    </i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <a href="#" class="text-gray-800 text-hover-primary fs-6 fw-bold">
                                    {{ shop.shopName }}
                                </a>
                                <span class="text-gray-500 fw-semibold d-block fs-7">{{ shop.shopDomain }}</span>
                            </div>
                            {% if shop.lastSyncAt %}
                            <span class="badge badge-light-success">{{ shop.lastSyncAt|date('H:i') }}</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-10">
                            <i class="ki-duotone ki-shop fs-5x text-gray-400 mb-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                            <h3 class="text-gray-800 fs-4 fw-bold mb-2">Mağaza Yok</h3>
                            <p class="text-gray-500 fs-6 mb-5">Henüz aktif mağaza bulunmuyor</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Monthly Stats Chart #}
    <div class="row g-5 g-xl-10 mb-5 mb-xl-10">
        <div class="col-xl-12">
            <div class="card card-flush h-xl-100">
                <div class="card-header pt-7">
                    <h3 class="card-title align-items-start flex-column">
                        <span class="card-label fw-bold text-gray-800">Aylık Sipariş Grafiği</span>
                        <span class="text-gray-500 mt-1 fw-semibold fs-6">Son 6 ay</span>
                    </h3>
                    <div class="card-toolbar">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-color-muted btn-active btn-active-primary">Gün</button>
                            <button type="button" class="btn btn-sm btn-color-muted btn-active btn-active-primary active">Hafta</button>
                            <button type="button" class="btn btn-sm btn-color-muted btn-active btn-active-primary">Ay</button>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-6">
                    <div id="kt_charts_monthly_orders" style="height: 300px"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    
    {# Performance Chart Widget #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Performance Overview Chart
            var performanceChart = document.getElementById('kt_card_widget_17_chart');
            if (performanceChart) {
                var options = {
                    series: [{
                        name: 'Gönderiler',
                        data: [30, 45, 32, 70, 40, 40, 40]
                    }],
                    chart: {
                        fontFamily: 'inherit',
                        type: 'area',
                        height: 300,
                        toolbar: {
                            show: false
                        },
                        zoom: {
                            enabled: false
                        },
                        sparkline: {
                            enabled: true
                        }
                    },
                    plotOptions: {},
                    legend: {
                        show: false
                    },
                    dataLabels: {
                        enabled: false
                    },
                    fill: {
                        type: 'solid',
                        opacity: 1
                    },
                    stroke: {
                        curve: 'smooth',
                        show: true,
                        width: 3,
                        colors: ['#17C653']
                    },
                    xaxis: {
                        categories: ['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'],
                        axisBorder: {
                            show: false,
                        },
                        axisTicks: {
                            show: false
                        },
                        labels: {
                            show: false,
                            style: {
                                colors: '#A1A5B7',
                                fontSize: '12px'
                            }
                        },
                        crosshairs: {
                            show: false,
                            position: 'front',
                            stroke: {
                                color: '#E5E7EB',
                                width: 1,
                                dashArray: 3
                            }
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    yaxis: {
                        min: 0,
                        max: 80,
                        labels: {
                            show: false,
                            style: {
                                colors: '#A1A5B7',
                                fontSize: '12px'
                            }
                        }
                    },
                    states: {
                        normal: {
                            filter: {
                                type: 'none',
                                value: 0
                            }
                        },
                        hover: {
                            filter: {
                                type: 'none',
                                value: 0
                            }
                        },
                        active: {
                            allowMultipleDataPointsSelection: false,
                            filter: {
                                type: 'none',
                                value: 0
                            }
                        }
                    },
                    tooltip: {
                        style: {
                            fontSize: '12px'
                        },
                        y: {
                            formatter: function (val) {
                                return  val + " gönderi"
                            }
                        }
                    },
                    colors: ['#17C653'],
                    markers: {
                        colors: ['#17C653'],
                        strokeColors: ['#17C653'],
                        strokeWidth: 3
                    }
                };

                var chart = new ApexCharts(performanceChart, options);
                chart.render();
            }

            // Monthly Orders Chart
            var monthlyChart = document.getElementById('kt_charts_monthly_orders');
            if (monthlyChart) {
                var monthlyOptions = {
                    series: [{
                        name: 'Siparişler',
                        data: [30, 40, 45, 50, 49, 60]
                    }],
                    chart: {
                        fontFamily: 'inherit',
                        type: 'area',
                        height: 300,
                        toolbar: {
                            show: false
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        curve: 'smooth',
                        show: true,
                        width: 3,
                        colors: ['#009EF7']
                    },
                    xaxis: {
                        categories: ['Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim'],
                        axisBorder: {
                            show: false,
                        },
                        axisTicks: {
                            show: false
                        },
                        labels: {
                            style: {
                                colors: '#A1A5B7',
                                fontSize: '12px'
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                colors: '#A1A5B7',
                                fontSize: '12px'
                            }
                        }
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.3,
                            opacityTo: 0.7,
                            stops: [0, 90, 100]
                        }
                    },
                    colors: ['#009EF7'],
                    grid: {
                        borderColor: '#F1F1F2',
                        strokeDashArray: 4,
                        yaxis: {
                            lines: {
                                show: true
                            }
                        }
                    }
                };

                var monthlyChartInstance = new ApexCharts(monthlyChart, monthlyOptions);
                monthlyChartInstance.render();
            }
        });
    </script>
{% endblock %}

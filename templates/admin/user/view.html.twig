{% extends 'layout/base.html.twig' %}

{% block title %}{{ user.fullName }} | Kullanıcılar | {{ parent() }}{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
        <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
            <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">{{ user.fullName }}</h1>
                <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                    <li class="breadcrumb-item text-muted">
                        <a href="{{ path('admin_dashboard') }}" class="text-muted text-hover-primary">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <span class="bullet bg-gray-500 w-5px h-2px"></span>
                    </li>
                    <li class="breadcrumb-item text-muted">
                        <a href="{{ path('admin_users') }}" class="text-muted text-hover-primary">Kullanıcılar</a>
                    </li>
                    <li class="breadcrumb-item">
                        <span class="bullet bg-gray-500 w-5px h-2px"></span>
                    </li>
                    <li class="breadcrumb-item text-muted">{{ user.fullName }}</li>
                </ul>
            </div>
            <div class="d-flex align-items-center gap-2 gap-lg-3">
                <a href="{{ path('admin_users_edit', {id: user.id}) }}" class="btn btn-sm fw-bold btn-primary">
                    <i class="ki-duotone ki-pencil fs-2"><span class="path1"></span><span class="path2"></span></i>Düzenle
                </a>
            </div>
        </div>
    </div>
    <!--end::Toolbar-->

    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-xxl">
            <div class="row g-6 g-xl-9">
                <!--begin::Col-->
                <div class="col-lg-4">
                    <!--begin::Summary-->
                    <div class="card card-flush h-lg-100">
                        <div class="card-header mt-6">
                            <div class="card-title flex-column">
                                <div class="symbol symbol-100px mb-5">
                                    <div class="symbol-label fs-2x fw-bold bg-light-primary text-primary">
                                        {{ user.firstName|slice(0, 1)|upper }}{{ user.lastName|slice(0, 1)|upper }}
                                    </div>
                                </div>
                                <h3 class="fw-bold mb-1">{{ user.fullName }}</h3>
                                <span class="fw-semibold text-gray-600">{{ user.email }}</span>
                            </div>
                        </div>
                        <div class="card-body pt-5 fs-6">
                            <div class="d-flex flex-stack mb-5">
                                <div class="fw-semibold pe-2">Durum:</div>
                                <div class="text-gray-600 fw-bold">
                                    {% if user.isActive %}
                                    <span class="badge badge-success">Aktif</span>
                                    {% else %}
                                    <span class="badge badge-danger">Pasif</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex flex-stack mb-5">
                                <div class="fw-semibold pe-2">Telefon:</div>
                                <div class="text-gray-600 fw-bold">{{ user.phone ?? '-' }}</div>
                            </div>
                            <div class="d-flex flex-stack mb-5">
                                <div class="fw-semibold pe-2">Dil:</div>
                                <div class="text-gray-600 fw-bold">{{ user.locale|upper }}</div>
                            </div>
                            <div class="d-flex flex-stack mb-5">
                                <div class="fw-semibold pe-2">2FA:</div>
                                <div class="text-gray-600 fw-bold">
                                    {% if user.is2FAEnabled %}
                                    <span class="badge badge-success">Aktif</span>
                                    {% else %}
                                    <span class="badge badge-light">Pasif</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex flex-stack mb-5">
                                <div class="fw-semibold pe-2">Son Giriş:</div>
                                <div class="text-gray-600 fw-bold">
                                    {{ user.lastLoginAt ? user.lastLoginAt|date('d.m.Y H:i') : '-' }}
                                </div>
                            </div>
                            <div class="d-flex flex-stack mb-5">
                                <div class="fw-semibold pe-2">Kayıt Tarihi:</div>
                                <div class="text-gray-600 fw-bold">{{ user.createdAt|date('d.m.Y H:i') }}</div>
                            </div>
                        </div>
                    </div>
                    <!--end::Summary-->
                </div>
                <!--end::Col-->

                <!--begin::Col-->
                <div class="col-lg-8">
                    <!--begin::Tab Content-->
                    <div class="card card-flush h-lg-100">
                        <!--begin::Card header-->
                        <div class="card-header">
                            <ul class="nav nav-stretch nav-line-tabs nav-line-tabs-2x border-transparent fs-5 fw-bold">
                                <li class="nav-item">
                                    <a class="nav-link text-active-primary active" data-bs-toggle="tab" href="#kt_user_view_overview">Genel Bakış</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-active-primary" data-bs-toggle="tab" href="#kt_user_view_roles">Roller & İzinler</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-active-primary" data-bs-toggle="tab" href="#kt_user_view_shops">Mağazalar</a>
                                </li>
                            </ul>
                        </div>
                        <!--end::Card header-->

                        <!--begin::Card body-->
                        <div class="card-body pt-0">
                            <div class="tab-content">
                                <!--begin::Tab pane - Overview-->
                                <div class="tab-pane fade show active" id="kt_user_view_overview" role="tabpanel">
                                    <div class="py-5">
                                        <h5 class="mb-4">Kullanıcı Detayları</h5>
                                        <table class="table table-row-dashed table-row-gray-300">
                                            <tbody>
                                                <tr>
                                                    <td class="fw-bold">Ad Soyad</td>
                                                    <td>{{ user.fullName }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">E-posta</td>
                                                    <td>{{ user.email }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Telefon</td>
                                                    <td>{{ user.phone ?? '-' }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Symfony Rolleri</td>
                                                    <td>
                                                        {% for role in user.roles %}
                                                        <span class="badge badge-light-info me-1">{{ role }}</span>
                                                        {% endfor %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Kayıt Tarihi</td>
                                                    <td>{{ user.createdAt|date('d.m.Y H:i') }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Son Güncelleme</td>
                                                    <td>{{ user.updatedAt|date('d.m.Y H:i') }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!--end::Tab pane-->

                                <!--begin::Tab pane - Roles-->
                                <div class="tab-pane fade" id="kt_user_view_roles" role="tabpanel">
                                    <div class="py-5">
                                        <div class="d-flex justify-content-between align-items-center mb-5">
                                            <h5 class="m-0">Atanmış Roller</h5>
                                            <a href="{{ path('admin_users_roles', {id: user.id}) }}" class="btn btn-sm btn-light-primary">
                                                <i class="ki-duotone ki-pencil fs-3">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                Rolleri Düzenle
                                            </a>
                                        </div>

                                        {% if user.userRoles|length > 0 %}
                                        <div class="row g-5">
                                            {% for role in user.userRoles %}
                                            <div class="col-md-6">
                                                <div class="card border border-dashed border-primary">
                                                    <div class="card-body">
                                                        <div class="d-flex align-items-center mb-3">
                                                            <i class="ki-duotone ki-shield fs-2x text-primary me-3">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                            </i>
                                                            <div>
                                                                <h5 class="mb-0">{{ role.name }}</h5>
                                                                <span class="badge badge-light-info fs-8">{{ role.slug }}</span>
                                                            </div>
                                                        </div>
                                                        {% if role.description %}
                                                        <p class="text-muted fs-7 mb-3">{{ role.description }}</p>
                                                        {% endif %}
                                                        <div class="d-flex justify-content-between text-muted fs-7">
                                                            <span>Seviye: {{ role.level }}</span>
                                                            <span>{{ role.permissions|length }} İzin</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>

                                        <div class="separator my-6"></div>

                                        <h5 class="mb-4">Tüm İzinler</h5>
                                        <div class="table-responsive">
                                            <table class="table table-row-dashed">
                                                <thead>
                                                    <tr class="fw-bold text-muted">
                                                        <th>İzin</th>
                                                        <th>Modül</th>
                                                        <th>Kaynak Rol</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% set allPermissions = {} %}
                                                    {% for role in user.userRoles %}
                                                        {% for permission in role.permissions %}
                                                            {% if not allPermissions[permission.slug] is defined %}
                                                                {% set allPermissions = allPermissions|merge({(permission.slug): {'permission': permission, 'role': role}}) %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endfor %}

                                                    {% for item in allPermissions %}
                                                    <tr>
                                                        <td>
                                                            <i class="ki-duotone ki-check-circle fs-3 text-success me-2">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                            </i>
                                                            {{ item.permission.name }}
                                                        </td>
                                                        <td><span class="badge badge-light-primary">{{ item.permission.module }}</span></td>
                                                        <td><span class="badge badge-light-info">{{ item.role.name }}</span></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <div class="text-center py-10">
                                            <i class="ki-duotone ki-information-5 fs-5x text-muted mb-5">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                            </i>
                                            <p class="text-muted fs-5">Bu kullanıcıya henüz rol atanmamış</p>
                                            <a href="{{ path('admin_users_roles', {id: user.id}) }}" class="btn btn-sm btn-primary mt-3">
                                                Rol Ata
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <!--end::Tab pane-->

                                <!--begin::Tab pane - Shops-->
                                <div class="tab-pane fade" id="kt_user_view_shops" role="tabpanel">
                                    <div class="py-5">
                                        <h5 class="mb-4">Mağazalar ({{ user.shops|length }})</h5>
                                        {% if user.shops|length > 0 %}
                                        <div class="table-responsive">
                                            <table class="table table-row-dashed">
                                                <thead>
                                                    <tr class="fw-bold text-muted">
                                                        <th>Mağaza Adı</th>
                                                        <th>Platform</th>
                                                        <th>Durum</th>
                                                        <th>Oluşturulma</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for shop in user.shops %}
                                                    <tr>
                                                        <td>{{ shop.name }}</td>
                                                        <td><span class="badge badge-light-success">Shopify</span></td>
                                                        <td>
                                                            {% if shop.isActive %}
                                                            <span class="badge badge-success">Aktif</span>
                                                            {% else %}
                                                            <span class="badge badge-danger">Pasif</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ shop.createdAt|date('d.m.Y') }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <div class="text-center py-10">
                                            <i class="ki-duotone ki-shop fs-5x text-muted mb-5">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                                <span class="path4"></span>
                                                <span class="path5"></span>
                                            </i>
                                            <p class="text-muted fs-5">Bu kullanıcıya ait mağaza bulunmuyor</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <!--end::Tab pane-->
                            </div>
                        </div>
                        <!--end::Card body-->
                    </div>
                    <!--end::Tab Content-->
                </div>
                <!--end::Col-->
            </div>
        </div>
    </div>
    <!--end::Content-->
</div>
{% endblock %}
